##
##   Copyright 2015 Futur Solo
##
##   Licensed under the Apache License, Version 2.0 (the "License");
##   you may not use this file except in compliance with the License.
##   You may obtain a copy of the License at
##
##       http://www.apache.org/licenses/LICENSE-2.0
##
##   Unless required by applicable law or agreed to in writing, software
##   distributed under the License is distributed on an "AS IS" BASIS,
##   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
##   See the License for the specific language governing permissions and
##   limitations under the License.
<!DOCTYPE HTML>
<html>
<head>
    <title><%block name="title">${page_title}</%block></title>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="referrer" content="origin">
    <meta property="og:title" content="${origin_title}">
    <meta property="og:url" content="${config["site_url"]}">
    <meta property="og:site_name" content="${config["site_name"]}">
    <meta name="description" content="${config["site_description"]}">
    <meta name="keywords" content="${config["site_keywords"]}">
    <meta name="generator" content="${FurtherLand.version()}">
    <link rel="canonical" href="${config["site_url"]}">
    <link rel="alternate" type="application/atom+xml" href="/feed.xml">
    <meta name="format-detection" content="telephone=no">
    <link href="//fonts.googleapis.com/css?family=Oxygen:400,700" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="${static_url("highlight.min.js")}">
    <link href="${static_url("framework.css")}" rel="stylesheet" type="text/css"><%block name="css"/>
</head>
<body>
    ${self.body()}
    <script src="${static_url("jquery.min.js")}" charset="utf-8"></script>
    <script src="${static_url("highlight.min.js")}"></script>
    <script src="${static_url("framework.js")}" charset="utf-8"></script>
    ${config["trace_code"]}<%block name="js"/>
</body>
</html>
<%def name="header()">
<header style="background-image: url(${static_url("haru-header.jpg")});">
    <div class="container">
        <div class="check-control">
        % if not current_user:
            <div class="right">
                <a href="/management/checkin" class="check-button">登录</a>
            </div>
        % else:
            <div class="left">
                <a href="/management" class="check-button">${config["site_name"]}管理局</a>
            </div>
            <div class="right">
                <a href="/management/checkout" class="check-button">登出</a>
            </div>
        % endif
        </div>
        <div class="site-name"><a href="${config["site_url"]}">${config["site_name"]}</a></div>
        <div class="site-description">${config["site_description"]}</div>
    </div>
</header>
</%def>
<%def name="footer()">
<footer>
    <div class="container">
        <div class="information">处理时间：${used_time}ms</div>
        <div class="copyright">&copy; 2015 <a href="${config["site_url"]}">${config["site_name"]}</a> All Rights Reserved.</div>
        <div class="powered">Powered by <a href="https://github.com/futursolo/FurtherLand">${FurtherLand.version()}</a>.</div>
    </div>
</footer>
</%def>
<%def name="replies()">
<div class="replies">
    <div class="container">
        <div class="title">评论</div>
        <div id="reply-list"></div>
        <div id="reply-alert"></div>
        % if current_user:
        <div class="new-reply">
            <div class="avatar-area">
                <div id="reply-avatar" class="avatar" style="background-image: url(${get_avatar(current_user, static_url)})"></div>
                <div class="reply-name">${current_user["username"]}</div>
                <a href="/management/checkout"><div id="visitor-checkout" class="button red">退出</div></a>
                <div id="publish-reply" class="button">发表</div>
            </div>
            <input id="reply-writing" type="hidden" value="${writing["_id"]}">
            <div id="reply-textarea-wrapper" class="textarea">
                <textarea class="hidden-textarea"></textarea>
                <textarea id="reply-textarea" class="visible-textarea" placeholder="評論支持Markdown哦！廣告和Spam統統惡靈退散！"></textarea>
            </div>
        </div>
        % elif current_visitor:
            <div class="new-reply">
                <div class="avatar-area">
                    <div id="reply-avatar" class="avatar" style="background-image: url(${get_avatar(current_visitor, static_url)})"></div>
                    <div class="reply-name">${current_visitor["name"]}</div>
                    <a href="/visitor/checkout"><div id="visitor-checkout" class="button red">退出</div></a>
                    <div id="publish-reply" class="button">发表</div>
                </div>
                <input id="reply-writing" type="hidden" value="${writing["_id"]}">
                <div id="reply-textarea-wrapper" class="textarea">
                    <textarea class="hidden-textarea"></textarea>
                    <textarea id="reply-textarea" class="visible-textarea" placeholder="評論支持Markdown哦！廣告和Spam統統惡靈退散！"></textarea>
                </div>
            </div>
        % else:
            <div class="social_login_area">
                <div class="introduction">在評論之前，請先登錄！</div>
                <a href="/visitor/github?next=${handler.request.uri}" style="border-bottom: none !important;">
                    <div class="social_login" style="background-image: url(${static_url("social-github.png")})"></div>
                </a>
                <div class="social_login" style="background-image: url(${static_url("social-google.png")}); display: none;"></div>
            </div>
        % endif
    </div>
</div>
</%def>
<%!
    import hashlib
    import base64
    def get_avatar(current_user, static_url):
        if not current_user:
            return static_url("mm.jpg")
        else:
            email = hashlib.md5(current_user["email"].lower().encode(encoding="utf-8")).hexdigest()
            return "/channel/avatar/" + email + "?s=200&d=mm"
%>
